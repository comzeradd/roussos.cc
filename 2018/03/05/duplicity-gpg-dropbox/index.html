<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>nikos.roussos &bull; Encrypted cloud backups with Duplicity and GPG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="nikos.roussos">
    <meta property="og:site_name" content="nikos.roussos">
    
  <meta property="og:title" content="Encrypted cloud backups with Duplicity and GPG">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://www.roussos.cc/2018/03/05/duplicity-gpg-dropbox/">
  
    
      <meta property="og:image" content="https://www.roussos.cc/2018/03/05/duplicity-gpg-dropbox/dpbx-create_app.jpg">
    
      <meta property="og:image" content="https://www.roussos.cc/2018/03/05/duplicity-gpg-dropbox/dpbx-gen_key.jpg">
    
  
  <meta property="og:description" content="why You already do regular offline backups right? If not, pause reading. Go buy an external drive, encrypt it with LUKS and backup your files. Now, welcome back. I wanted a way to backup my (important) files on the cloud someone else&#39;s computer. I have two main reasons for that. First of all, I want...">

    <link rel="stylesheet" href="/static/css/lib/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/lib/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/static/css/app.css">
    
    <link rel="shortcut icon" href="/favicon.ico">

  </head>

  <body>
    <div id="wrapper">

      <div class="container">
        <div class="row">
          <div class="col-md-12 text-center">
            <p class="avatar">
              <a href="/">
                <img src="/static/img/me.jpg" alt="Nikos Roussos" class="avatar img-circle" />
              </a>
            </p>
            <h3 >
              <a href="/index.html">About</a> &bull;
              <a href="/blog.html">Blog</a> &bull;
              <a href="/projects.html">Projects</a> &bull;
              <a href="/music.html">Music</a> &bull;
              <a href="/places.html">Places</a> &bull;
              <a href="/contact.html">Contact</a>
            </h3>
          </div>
        </div>
      </div>

      <div class="content">
        
  <div class="container">
    <div class="row">
      <div class="col-md-12 post-title">
        <h3>
          <a href="/2018/03/05/duplicity-gpg-dropbox/">Encrypted cloud backups with Duplicity and GPG</a>
        </h3>
        <small>
          2018.03.05 -
          
            <a href="/tag/opensource/">#opensource</a>
          
        </small>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-md-12 post">
        <h3>why</h3>
<p>You already do regular offline backups right? If not, pause reading. Go buy an external drive, encrypt it with LUKS and backup your files. Now, welcome back.</p>
<p>I wanted a way to backup my (important) files on <s>the cloud</s> someone else's computer. I have two main reasons for that. First of all, I want to have a backup outside the premises of my home. Sometimes accidents happen, or someone could just break in or raid my place and take my backups. Of course these are encrypted but I'd have lost access to my files. Another reason is that I want to be able to access my files from any device (not necessarily mine) and from anywhere in the world.</p>
<p>In this example I'm using Dropbox as an example of cloud storage. You can replace Dropbox with almost any commercial or not cloud storage service out there, your self-hosted VPS, etc. I chose Dropbox for this example for its simplicity and popularity, but also to emphasize one more aspect. If you trust encryption, which happens at your end, then you don't need to trust the storage provider. At least not in terms of security. You would still need to trust the reliability of whatever endpoint you choose. Dropbox in that scenario is as good as your self-hosted server.</p>
<h3>the backup script</h3>
<p>The basic ingredients are <a href="http://duplicity.nongnu.org/">Duplicity</a> and GnuPG. I'll insert here the backup script and then I'll explain in detail how this works and what things you need to customize.</p>
<pre><code>#!/usr/bin/env bash
set -e

# Dropbox configuration variables
DROPBOX_FOLDER="mybackup"
export DPBX_ACCESS_TOKEN=""
export PASSPHRASE=""

# Folders to backup
MY_PRECIOUS="/precious"
SECRET_DATA="/data/secret"

# Remove files older than 60 days from Dropbox
duplicity remove-older-than 60D --force dpbx://${DROPBOX_FOLDER}
# Sync everything to Dropbox
duplicity --include=${MY_PRECIOUS} --include=${SECRET_DATA} --exclude='**' / dpbx://${DROPBOX_FOLDER}
# Cleanup failures
duplicity cleanup --force dpbx://${DROPBOX_FOLDER}

unset DPBX_ACCESS_TOKEN
unset PASSPHRASE
</code></pre>
<p>Duplicity has a very simple interface that can be summarized with this line:</p>
<pre><code>duplicity [source] [destination]
</code></pre>
<p>You can provide one source and one destination, but you can use the <code>--include</code> and <code>--exclude</code> options to customize things. One important thing to remember is that the more left is such an option the bigger precedence it has. Here is our main backup line:</p>
<pre><code>duplicity --include=${MY_PRECIOUS} --include=${SECRET_DATA} --exclude='**' / dpbx://${DROPBOX_FOLDER}
</code></pre>
<p>So reading this line from right to left can help you better understand what it actually does. We instruct Duplicity that our destination is a Dropbox folder. We want to back everything (<code>/</code>), but then we exclude everything (<code>'**'</code>) and include only the two folders we want in this case. A simpler example would be to backup our home directory and exclude specific folders. That would look like this:</p>
<pre><code>duplicity --exclude=${NOT_THIS_FOLDER} --exclude=${TMP_FOLDER} /home/myuser dpbx://${DROPBOX_FOLDER}
</code></pre>
<p>Anything that starts with a <code>$</code> sign is a variable, so we set everything in the beginning of the script and unset the sensitive things at the end.</p>
<p>Duplicity has certain name convetions for things. So <code>DPBX_ACCESS_TOKEN</code> is the Dropbox token (see below) and <code>PASSPHRASE</code> is the encryption key. It will use GPG to do the encryption and since we provide a passphrase and not a key fingerprint it will use symmetric encryption. You can of course use your PGP key if you want, but as I already mentioned I want to be able to fetch and decrypt the backup from anywhere. That means that I may not have access to my PGP key.</p>
<h3>Dropbox</h3>
<p>The nice thing about this workflow is that you don't need to run any Dropbox related code to your machine. All you need is go to Dropbox developers portal and <a href="https://www.dropbox.com/developers/apps/create">create a new app</a>. Choose to create an "App folder" kind of app and pick a name, as shown in the screenshot below.</p>
<p><img alt="dropbox create app" src="/2018/03/05/duplicity-gpg-dropbox/dpbx-create_app.jpg" /></p>
<p>On the next screen all you need to do is generate an access token. It's the string you need to use on the <code>DPBX_ACCESS_TOKEN</code> variable of your backup script. And that's it!</p>
<p><img alt="dropbox generate key" src="/2018/03/05/duplicity-gpg-dropbox/dpbx-gen_key.jpg" /></p>
<h3>Final bits</h3>
<ol>
<li>Pick a really really long passphrase.</li>
<li>Adjust your backup script permissions to make it accessible only to your eyes. </li>
<li>Duplicity does incremental backups, so you can just cron the script to run daily, weekly or whatever fits your needs.</li>
<li>Let it run a few times and then try to restore your files. Backups that don't restore properly are useless.</li>
</ol>

        <div class="post-share">
          Share:
          <a href="https://sharetodiaspora.github.io/?title=Encrypted cloud backups with Duplicity and GPG&amp;url=https://www.roussos.cc/2018/03/05/duplicity-gpg-dropbox/" target="_blank">
            <img src="https://sharetodiaspora.github.io/favicon.png" alt="diaspora*"> diaspora*
          </a>
        </div>
      </div>
    </div>
  </div>




      </div>

    </div>

    <div id="footer" >
      <div class="container">
        powered by <a href="https://github.com/comzeradd/monopati" target="_blank">monopati</a> &bull;
       <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">Creative Commons Attribution-ShareAlike</a>
      </div>
    </div>

    <script src="/static/js/lib/jquery-1.11.2.min.js"></script>
    <script src="/static/js/lib/bootstrap.min.js"></script>
    
    
  </body>
</html>